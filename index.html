<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="http://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.42" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

  <title>Pavel Derendyaev test</title>

  
  <link type="text/css" rel="stylesheet" href="http://blog.dddpaul.pw/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="http://blog.dddpaul.pw/css/poole.css">
  <link type="text/css" rel="stylesheet" href="http://blog.dddpaul.pw/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="http://blog.dddpaul.pw/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="http://blog.dddpaul.pw/index.xml" rel="alternate" type="application/rss+xml" title="Pavel Derendyaev test" />

  
</head>

<body>

<div class="sidebar">
    <div class="container sidebar-sticky">
        <div class="sidebar-about">
            <h1>Pavel Derendyaev test</h1>
            <p class="lead">
                   
            </p>
        </div>

        <ul class="sidebar-nav">
            <li><a href="/">Home</a> </li>
            
            <li><a href="http://github.com/dddpaul"> GitHub </a></li>
            
            <li><a href="/index.xml"> RSS </a></li>
            
        </ul>

        Tags:
        <ul>
            
            
            <li><a href="http://blog.dddpaul.pw//tags/devops/">devops</a> </li>
            
            <li><a href="http://blog.dddpaul.pw//tags/docker/">docker</a> </li>
            
            <li><a href="http://blog.dddpaul.pw//tags/git/">git</a> </li>
            
            <li><a href="http://blog.dddpaul.pw//tags/golang/">golang</a> </li>
            
            <li><a href="http://blog.dddpaul.pw//tags/hugo/">hugo</a> </li>
            
            <li><a href="http://blog.dddpaul.pw//tags/java/">java</a> </li>
            
            <li><a href="http://blog.dddpaul.pw//tags/kafka/">kafka</a> </li>
            
            <li><a href="http://blog.dddpaul.pw//tags/linux/">linux</a> </li>
            
        </ul>

        <p>&copy; 2018. All rights reserved. </p>
    </div>
</div>


<div class="content container">
    <div class="posts">

        
        <div class="post">
            <h1 class="post-title">
                <a href="http://blog.dddpaul.pw/2018/06/24/firewalld-zones/">
                    Bind interfaces to multiple zones with Firewalld on CentOS-7
                </a>
            </h1>

            <span class="post-date">2018-06-24</span>

            <p>As you can expect from <a href="http://linuxmanpages.net/manpages/fedora20/man1/firewall-cmd.1.html">man firewall-cmd</a> interface binding to zone other than default (public) could be achieved with the following command sequence:</p>

<pre><code>firewall-cmd --zone public --remove-interface eth1 --permanent
firewall-cmd --zone internal --add-interface eth1 --permanent
firewall-cmd --reload
</code></pre>

<p>Seems like it&rsquo;s done:</p>

<pre><code>firewall-cmd --get-zone-of-interface=eth1
internal
</code></pre>

<p>But after firewalld restart or server reboot things aren&rsquo;t so bright:</p>

<pre><code>firewall-cmd --get-zone-of-interface=eth1
public
</code></pre>

<p>The reason is in this <a href="https://bugs.centos.org/view.php?id=7526">CentOS-7 bug</a>. The only workaround is to specify zone in <em>/etc/sysconfig/network-scripts/ifcfg-eth1</em> file:</p>

<pre><code>TYPE=Ethernet
NAME=&quot;eth1&quot;
IPADDR=x.x.x.x
...
ZONE=internal
</code></pre>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://blog.dddpaul.pw/2018/06/24/docker-network-swarm-links/">
                    Docker network and Swarm mode links
                </a>
            </h1>

            <span class="post-date">2018-06-24</span>

            <p>Some useful articles &amp; videos about modern networking in Docker:</p>

<ul>
<li><a href="https://github.com/docker/libnetwork/blob/master/docs/macvlan.md">Macvlan Driver</a> - Docker Macvlan driver is out of experimental in Docker 1.12.</li>
<li><a href="http://networkstatic.net/configuring-macvlan-ipvlan-linux-networking/">Configuring Macvlan and Ipvlan Linux Networking</a> - What Docker Macvlan driver does under the hood.</li>
<li><a href="https://github.com/lowescott/2016-dnf-materials">Materials for 2016 DevOps Networking Forum (DNF) Presentation</a> - Slides about Docker networking with Ansible playbooks.</li>
<li><a href="https://habrahabr.ru/company/badoo/blog/304702/">Видео докладов с Docker митапа</a> - Особо интересен доклад Константина Назарова &ldquo;Каждому контейнеру по IP&rdquo; (на русском).</li>
</ul>

<p>Swarm mode was presented in Docker 1.12:</p>

<ul>
<li><a href="https://blog.docker.com/2016/07/docker-built-in-orchestration-ready-for-production-docker-1-12-goes-ga/">Docker Built-In Orchestration Ready For Production: Docker 1.12 Goes GA</a> - Post from Docker blog about Swarm mode release. It contains some links to the videos.</li>
<li><a href="http://blog.hypriot.com/post/more-microservice-bliss-with-docker-1-12/">More Microservices Bliss with Docker 1.12 and Swarm only</a> - Seems like <a href="https://traefik.io/">Traefik</a> can be partially replaced with Docker 1.12. routing mesh.</li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://blog.dddpaul.pw/2018/06/24/docker-registry/">
                    Docker registry on Centos 7
                </a>
            </h1>

            <span class="post-date">2018-06-24</span>

            <p><strong>1.</strong> Create logical volumes for <code>direct-lvm</code> production mode</p>

<p>Assume that we have 40 GByte block device named as <code>/dev/sdb</code> with one full-size Linux partition on it.</p>

<p>Official <a href="https://docs.docker.com/engine/userguide/storagedriver/device-mapper-driver/">Device Mapper storage driver guide</a> recommends to use <a href="https://access.redhat.com/documentation/en-US/Red_Hat_Enterprise_Linux/6/html/Logical_Volume_Manager_Administration/thinprovisioned_volumes.html">thin pools</a> now. Use these commands to create thin-provisioned logical volumes:</p>

<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">pvcreate /dev/sdb1                 <span class="c1"># Create physical volume
</span><span class="c1"></span>vgcreate docker /dev/sdb1          <span class="c1"># Create volume group and add this physical volume to it
</span><span class="c1"># Create logical volumes
</span><span class="c1"></span>lvcreate --wipesignatures y -n data docker -l <span class="m">40</span>%VG
lvcreate --wipesignatures y -n registry docker -l <span class="m">40</span>%VG
lvcreate --wipesignatures y -n metadata docker -l <span class="m">2</span>%VG
<span class="c1"># Convert data volume to thin pool&#39;s data volume
</span><span class="c1"></span>lvconvert -y --zero n -c 512K --thinpool docker/data --poolmetadata docker/metadata
<span class="c1"># Set thin pool autoextend features
</span><span class="c1"></span>cat &gt; /etc/lvm/profile/docker-data.profile
activation <span class="o">{</span>
        <span class="nv">thin_pool_autoextend_threshold</span> <span class="o">=</span> <span class="m">80</span>
        <span class="nv">thin_pool_autoextend_percent</span> <span class="o">=</span> <span class="m">20</span>
<span class="o">}</span>
lvchange --metadataprofile docker-data docker/data
<span class="c1"># Check thin pool volume (must be monitored) 
</span><span class="c1"></span>lvs -o+seg_monitor
  LV       VG     Attr       LSize   Pool Origin Data%  Meta%  Move Log Cpy%Sync Convert Monitor
  root     centos -wi-ao---- <span class="m">117</span>,19g
  swap     centos -wi-ao----   <span class="m">1</span>,95g
  data     docker twi-a-t---  <span class="m">16</span>,00g             <span class="m">0</span>,00   <span class="m">0</span>,01                             monitored
  registry docker -wi-a-----  <span class="m">16</span>,00g</code></pre></div>

<p>Or if you do not trust thin pools use more traditional (but deprecated in Docker) way:</p>

<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">pvcreate /dev/sdb1                 <span class="c1"># Create physical volume
</span><span class="c1"></span>vgcreate docker /dev/sdb1          <span class="c1"># Create volume group and add this physical volume to it
</span><span class="c1"></span>lvcreate -L 2G -n metadata docker  <span class="c1"># Create logical volume for Docker metadata
</span><span class="c1"></span>lvcreate -L 15G -n data docker     <span class="c1"># Create logical volume for Docker data (layers, containers etc)
</span><span class="c1"></span>lvcreate -L 15G -n registry docker # Create logical volume <span class="k">for</span> Docker Registry data</code></pre></div>

<p>Mount volume for Docker registry:</p>

<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">mkfs.xfs /dev/docker/registry
<span class="nb">echo</span> <span class="s2">&#34;/dev/docker/registry /var/lib/docker-registry    xfs     defaults        1 3&#34;</span> &gt;&gt; /etc/fstab 
mount -a</code></pre></div>

<p>Check:</p>

<pre><code>lsblk
NAME                             MAJ:MIN RM   SIZE RO TYPE MOUNTPOINT
sda                                8:0    0   120G  0 disk
├─sda1                             8:1    0   876M  0 part /boot
└─sda2                             8:2    0 119,1G  0 part
  ├─centos-swap                  253:0    0     2G  0 lvm  [SWAP]
  └─centos-root                  253:1    0 117,2G  0 lvm  /
sdb                                8:16   0    40G  0 disk
└─sdb1                             8:17   0    40G  0 part
  ├─docker-metadata              253:2    0     2G  0 lvm
  │ └─docker-253:1-23762136-pool 253:5    0    15G  0 dm
  ├─docker-data                  253:3    0    15G  0 lvm
  │ └─docker-253:1-23762136-pool 253:5    0    15G  0 dm
  └─docker-registry              253:4    0    15G  0 lvm  /var/lib/docker-registry
</code></pre>

<p><strong>2.</strong> Configure Docker daemon</p>

<p>Create systemd drop-in file:</p>

<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">mkdir -p /etc/systemd/system/docker.service.d
cat &gt; /etc/systemd/system/docker.service.d/env.conf 
<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">EnvironmentFile</span><span class="o">=</span>-/etc/sysconfig/docker
<span class="nv">ExecStart</span><span class="o">=</span>
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/dockerd <span class="nv">$OPTIONS</span> <span class="nv">$DOCKER_NETWORK_OPTIONS</span> <span class="nv">$DOCKER_STORAGE_OPTIONS</span></code></pre></div>

<p>Specify Docker configuration:</p>

<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">cat &gt; /etc/sysconfig/docker 
<span class="nv">OPTIONS</span><span class="o">=</span><span class="s1">&#39;--iptables=false&#39;</span>
<span class="nv">DOCKER_NETWORK_OPTIONS</span><span class="o">=</span><span class="s1">&#39;&#39;</span>
<span class="nv">DOCKER_STORAGE_OPTIONS</span><span class="o">=</span><span class="s1">&#39;--storage-driver=devicemapper --storage-opt dm.datadev=/dev/docker/data --storage-opt dm.metadatadev=/dev/docker/metadata&#39;</span></code></pre></div>

<p>Check:</p>

<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">systemctl daemon-reload
systemctl show docker <span class="p">|</span> grep EnvironmentFile
<span class="nv">EnvironmentFile</span><span class="o">=</span>/etc/sysconfig/docker <span class="o">(</span><span class="nv">ignore_errors</span><span class="o">=</span>yes<span class="o">)</span></code></pre></div>

<p>And run:</p>

<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">systemctl <span class="nb">enable</span> docker
systemctl restart docker</code></pre></div>

<p>Check again:</p>

<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">docker info <span class="p">|</span> grep data
 Data file: /dev/docker/data
 Metadata file: /dev/docker/metadata
 Metadata Space Used: <span class="m">639</span> kB
 Metadata Space Total: <span class="m">2</span>.147 GB
 Metadata Space Available: <span class="m">2</span>.147 GB</code></pre></div>

<p><strong>3.</strong> Obtain SSL certificate from Let&rsquo;s Encrypt</p>

<p>It&rsquo;s can be done by different ways, see <a href="http://blog.dddpaul.pw/2018/06/24/lego-nginx/">Let&rsquo;s Encrypt with lego and Nginx</a> for one of these.</p>

<p>Assume that certificate and key was obtained and stored in <code>/etc/pki/tls/lego/certificates</code> directory.</p>

<p><strong>4.</strong> Run Docker registry container as systemd unit</p>

<p>Create systemd unit:</p>

<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">cat &gt; /etc/systemd/system/docker-registry.service
<span class="o">[</span>Unit<span class="o">]</span>
<span class="nv">Description</span><span class="o">=</span>Docker registry container
<span class="nv">Requires</span><span class="o">=</span>docker.service
<span class="nv">After</span><span class="o">=</span>docker.service

<span class="o">[</span>Service<span class="o">]</span>
<span class="nv">Restart</span><span class="o">=</span>always
<span class="nv">ExecStartPre</span><span class="o">=</span>/usr/bin/docker create -p <span class="m">5000</span>:5000 -v /var/lib/docker-registry:/var/lib/registry -v /etc/pki/tls/lego/certificates:/certs -e <span class="nv">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class="o">=</span>/certs/example.org.crt -e <span class="nv">REGISTRY_HTTP_TLS_KEY</span><span class="o">=</span>/certs/example.org.key --name registry registry:2
<span class="nv">ExecStart</span><span class="o">=</span>/usr/bin/docker start -a registry
<span class="nv">ExecStop</span><span class="o">=</span>/usr/bin/docker stop -t <span class="m">5</span> registry
<span class="nv">ExecStopPost</span><span class="o">=</span>/usr/bin/docker rm registry

<span class="o">[</span>Install<span class="o">]</span>
<span class="nv">WantedBy</span><span class="o">=</span>multi-user.target</code></pre></div>

<p><strong>5.</strong> Permit access to Docker registry only from trusted networks</p>

<div class="highlight"><pre class="chroma"><code class="language-shell" data-lang="shell">firewall-cmd --zone<span class="o">=</span>trusted --add-port<span class="o">=</span><span class="m">5000</span>/tcp --permanent
firewall-cmd --zone<span class="o">=</span>trusted --add-source<span class="o">=</span><span class="m">192</span>.168.1.0/24 --permanent
firewall-cmd --reload</code></pre></div>

<p>Since Docker daemon was launched with <code>--iptables=false</code> option, Docker registry port may be accessed from trusted networks only.</p>

<p>Links:</p>

<ul>
<li><a href="https://docs.docker.com/engine/admin/systemd/">Control and configure Docker with systemd</a></li>
<li><a href="https://docs.docker.com/engine/userguide/storagedriver/device-mapper-driver/">Docker and the Device Mapper storage driver</a></li>
<li><a href="http://trainingdevops.com/insights-and-tutorials/deploying-docker-registry-with-let-s-encrypt-ssl-tls-certs">Deploying Docker Registry with Let&rsquo;s Encrypt SSL/TLS Certs</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://blog.dddpaul.pw/2018/06/24/java-listeners/">
                    Java network listeners
                </a>
            </h1>

            <span class="post-date">2018-06-24</span>

            <p>I&rsquo;ve written a small <a href="https://github.com/dddpaul/java-network-listeners">listeners library</a> today. It allows to create Callables which can be submitted to <a href="http://docs.oracle.com/javase/7/docs/api/java/util/concurrent/ExecutorService.html">ExecutorService</a>. The callable itself implements creating server socket and binding it to local port.</p>

<p>There two principal type of listeners: blocking and non-blocking (thanks to <a href="http://en.wikipedia.org/wiki/Non-blocking_I/O_(Java)">Java NIO</a>.</p>

<hr />

<p>Blocking listener is very simple but in can&rsquo;t be interrupted by calling thread. So there&rsquo;s no point in that:</p>

<div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Future</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span> <span class="n">Listeners</span><span class="o">.</span><span class="na">createListener</span><span class="o">(</span> <span class="n">PORT</span> <span class="o">)</span> <span class="o">);</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">(</span> <span class="n">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span> <span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span><span class="o">(</span> <span class="n">TimeoutException</span> <span class="n">e</span> <span class="o">)</span> <span class="o">{</span>
    <span class="n">future</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span> <span class="kc">true</span> <span class="o">);</span>
<span class="o">}</span></code></pre></div>

<p>Listener will stay active and PORT will be bound still. The reason is in usage of the uninterruptible <a href="http://docs.oracle.com/javase/7/docs/api/java/net/ServerSocket.html#accept()">ServerSocket.accept()</a>.</p>

<hr />

<p>In contrary non-blocking listener is more sophisticated but it can be interrupted by calling thread. So you can do that:</p>

<p><div class="highlight"><pre class="chroma"><code class="language-java" data-lang="java"><span class="n">Future</span><span class="o">&lt;</span><span class="n">Socket</span><span class="o">&gt;</span> <span class="n">future</span> <span class="o">=</span> <span class="n">executor</span><span class="o">.</span><span class="na">submit</span><span class="o">(</span> <span class="n">Listeners</span><span class="o">.</span><span class="na">createListener</span><span class="o">(</span> <span class="n">PORT</span> <span class="o">)</span> <span class="o">);</span>
<span class="k">try</span> <span class="o">{</span>
    <span class="n">Socket</span> <span class="n">socket</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="na">get</span><span class="o">(</span> <span class="n">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">SECONDS</span> <span class="o">);</span>
<span class="o">}</span> <span class="k">catch</span><span class="o">(</span> <span class="n">TimeoutException</span> <span class="n">e</span> <span class="o">)</span> <span class="o">{</span>
    <span class="n">future</span><span class="o">.</span><span class="na">cancel</span><span class="o">(</span> <span class="kc">true</span> <span class="o">);</span>
<span class="o">}</span></code></pre></div></p>

<p>Listener will be terminated and PORT will be freed.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://blog.dddpaul.pw/2018/06/24/kafka-tips/">
                    Kafka tips &amp; tricks
                </a>
            </h1>

            <span class="post-date">2018-06-24</span>

            
<img src='http://blog.dddpaul.pw//media/apache-kafka.png'/>


<hr />

<p>Список консьюмер-групп</p>

<pre><code>docker run wurstmeister/kafka /opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server kafka:9092 --list
</code></pre>

<hr />

<p>Информация по консьюмер-группе</p>

<pre><code>docker run wurstmeister/kafka /opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server kafka:9092 --group id1 --describe
</code></pre>

<hr />

<p>Установка оффсета на начало</p>

<pre><code>docker run wurstmeister/kafka /opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server kafka:9092 --topic topic --group id1 --reset-offsets --to-earliest --execute
</code></pre>

<hr />

<p>Установка оффсета на конец</p>

<pre><code>docker run wurstmeister/kafka /opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server kafka:9092 --topic topic --group id1 --reset-offsets --to-latest --execute
</code></pre>

<hr />

<p>Установка оффсета на дату-время</p>

<pre><code>docker run wurstmeister/kafka /opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server kafka:9092 --topic topic --group id1 --reset-offsets --to-datetime &quot;2017-12-22T00:00:00.000&quot; --execute
</code></pre>

<hr />

<p>Установка оффсета на дату-время для партишенов 0, 1 (одно время для всех партишенов)</p>

<pre><code>docker run wurstmeister/kafka /opt/kafka/bin/kafka-consumer-groups.sh --bootstrap-server kafka:9092 --topic topic:0,1 --group id1 --reset-offsets --to-datetime &quot;2017-12-22T00:00:00.000&quot; --execute
</code></pre>

<hr />

<p>Установка оффсета на дату-время для партишенов 0, 1 (разное время для партишенов)</p>

<pre><code>docker run dddpaul/kafka-rewind --servers=kafka:9092 --group-id=id1 --topic=topic -o 0=2017-12-01 -o 1=2018-01-01
</code></pre>

<hr />

<p>Создать топик</p>

<pre><code>docker exec -it wurstmeister/kafka sh -c &quot;JMX_PORT=10001 /opt/kafka/bin/kafka-topics.sh --create --topic topic --replication-factor 1 --partitions 1 --zookeeper zookeeper:2181&quot;
</code></pre>

<hr />

<p>Накидать сообщений</p>

<pre><code>docker exec -it wurstmeister/kafka sh -c &quot;JMX_PORT=10001 /opt/kafka/bin/kafka-verifiable-producer.sh --topic topic --max-messages 200000 --broker-list localhost:9092&quot;
</code></pre>

<hr />

<p>Консольный консьюмер</p>

<pre><code>docker exec -it wurstmeister/kafka sh -c &quot;JMX_PORT=10001 /opt/kafka/bin/kafka-console-consumer.sh --topic topic --bootstrap-server host:9092&quot;
docker run -it wurstmeister/kafka -c &quot;JMX_PORT=10001 /opt/kafka/bin/kafka-console-consumer.sh --topic topic --bootstrap-server host:9092&quot;
docker run --entrypoint=/opt/kafka/bin/kafka-console-consumer.sh wurstmeister/kafka --topic topic --bootstrap-server host:9092
</code></pre>

<hr />

<p>Python консьюмер</p>

<pre><code>#!/usr/bin/env python
from kafka import KafkaConsumer
consumer = KafkaConsumer(bootstrap_servers='kafka1:9092',
                         group_id=None,
                         auto_offset_reset='earliest')
consumer.subscribe(['rsyslog_apps'])
for msg in consumer:
    print msg
</code></pre>

<hr />

<p>Kafkacat консьюмер</p>

<pre><code>docker run -it confluentinc/cp-kafkacat kafkacat -b host:9092 -t topic -o beginning -v
</code></pre>

<hr />

<p>Установка retention на топик</p>

<pre><code>docker exec -it kafka /opt/kafka/bin/kafka-configs.sh --zookeeper host:2181 --entity-type topics --entity-name topic --describe
docker exec -it kafka /opt/kafka/bin/kafka-topics.sh --zookeeper host:2181 --topic topic --describe
docker exec -it kafka /opt/kafka/bin/kafka-topics.sh --zookeeper host:2181 --topic topic --alter --config retention.ms=1000
</code></pre>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://blog.dddpaul.pw/2018/06/24/lego-nginx/">
                    Let&#39;s Encrypt with lego and Nginx
                </a>
            </h1>

            <span class="post-date">2018-06-24</span>

            <p><a href="https://github.com/xenolf/lego">xenolf/lego</a> it&rsquo;s a feature-rich Let&rsquo;s Encrypt client and ACME library written in Go.</p>

<p><strong>1.</strong> Prepare Nginx server</p>

<pre><code>server {
    listen 80 default;
    server_name example.org www.example.org;

    location /.well-known/acme-challenge {
        proxy_pass http://127.0.0.1:81;
        proxy_set_header Host $host;
    }

    # Other directives
}
</code></pre>

<p><strong>2.</strong> Update ca-certificates for CentOS 5 (optional)</p>

<p>Let&rsquo;s Encrypt CA certificate is not included into root CA bundle of old Linux distributions like RHEL/Centos 5. You have to replace this bundle manually with fresh one from <a href="http://curl.haxx.se/">cURL website</a>:</p>

<pre><code>cp /etc/pki/tls/certs/ca-bundle.crt /etc/pki/tls/certs/ca-bundle.crt.bak
wget -O /etc/pki/tls/certs/ca-bundle.crt http://curl.haxx.se/ca/cacert.pem
</code></pre>

<p><strong>3.</strong> Order the certificate from Let&rsquo;s Encrypt</p>

<pre><code>lego -d example.org -d www.example.org -m cert-owner@example.org -a --path=/etc/pki/tls/lego --http=:81 run
</code></pre>

<p><strong>4.</strong> Update Nginx server</p>

<pre><code>server {
    listen 80 default;
    server_name example.org www.example.org;

    location /.well-known/acme-challenge {
        proxy_pass http://127.0.0.1:81;
        proxy_set_header Host $host;
    }

    # Other directives
}

server {
    listen 443 ssl;
    server_name example.org www.example.org;

    ssl_certificate /etc/pki/tls/lego/certificates/example.org.crt;
    ssl_certificate_key /etc/pki/tls/lego/certificates/example.org.key;

    location /.well-known/acme-challenge {
        proxy_pass http://127.0.0.1:444;
        proxy_set_header Host $host;
    }

    # Other directives
}

</code></pre>

<p><strong>5.</strong> Renew certificate every 2 month at 01:30 of first day of the month</p>

<p>Add to crontab:</p>

<pre><code>30 01 01 */2 * /usr/local/bin/lego -d example.org -d www.example.org -m cert-owner@example.org -a --path=/etc/pki/tls/lego --http=:81 --tls=:444 renew &amp;&amp; /usr/sbin/nginx -s reload
</code></pre>

<p>Links:</p>

<ul>
<li><a href="https://github.com/xenolf/lego">Let&rsquo;s Encrypt client and ACME library written in Go</a></li>
<li><a href="https://code.kuederle.com/letsencrypt/">LET’S ENCRYPT WITH LEGO AND NGINX</a></li>
<li><a href="https://raymii.org/s/snippets/CentOS_5_CA_Certificate_Bundle_Update.html">CentOS 5 CA Certificate Bundle Update</a></li>
</ul>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://blog.dddpaul.pw/2018/06/24/docker-fig/">
                    Запуск контейнеров с помощью Fig
                </a>
            </h1>

            <span class="post-date">2018-06-24</span>

            

<p>Это третья статья цикла 
<a href='http://blog.dddpaul.pw//series/building-test-environments-with-docker/'>Building test environments with Docker</a>.</p>

<p>Как мы уже убедились, запуск контейнеров с помощью <code>docker run</code> — занятие весьма муторное, т.к. необходимо указывать множество опций. При запуске же нескольких контейнеров ситуация только ухудшается, т.к. теперь нужно задавать имена и линки.</p>

<p>Эту проблему решает инструмент <a href="http://www.fig.sh/">Fig</a>, который может запустить/остановить целое тестовое окружение, состоящее из набора контейнеров. Описание контейнеров задано в YAML-файле. Таким образом, этот YAML-файл представляет собой конфигурацию тестового окружения.</p>

<p>Конфигурация нашего тестового окружения <em>test-env/fig.yml</em>:</p>

<pre><code>app1:
  image: smile/app1
  ports: ['2021:22', '8081:80']
  privileged: true

app2:
  image: smile/app2
  ports: ['2022:22', '8082:80']
  privileged: true

gate:
  image: smile/gate
  links: [app1, app2]
  ports: ['2020:22', '80:80']
  privileged: true
</code></pre>

<p>Запуск тестового окружения (находясь в каталоге с файлом <em>fig.yml</em>): <code>fig up</code>.</p>

<p>По-умолчанию, Fig захватывает консоль и мультиплексирует вывод всех контейнеров. Для запуска в detached mode нужно использовать опцию <code>-d</code>. Посмотреть вывод контейнеров в этом режиме можно с помощью команды <code>fig logs</code>.</p>

<p>Статус тестового окружения: <code>fig ps</code>.</p>

<p>Остановка тестового окружения: <code>fig stop</code>.</p>

<h3 id="запуск-тестового-окружения-с-помощью-upstart">Запуск тестового окружения с помощью Upstart</h3>

<p>Job <em>/etc/init/fig-test-env.conf</em> создан на основе <a href="https://gist.github.com/HeyImAlex/9649374">HeyImAlex/fig.conf</a>. Для отключения автостарта нужно закомментировать вторую строчку (&ldquo;start on &hellip;&rdquo;).</p>

<pre><code>description &quot;Test environment runner&quot;
start on filesystem and started docker
stop on runlevel [!2345]
respawn
chdir /path/to/test-env
script
  # Wait for docker to finish starting up first.
  FILE=/var/run/docker.sock
  while [ ! -e $FILE ] ; do
    inotifywait -t 2 -e create $(dirname $FILE)
  done
  /usr/local/bin/fig up
end script
post-stop script
 /usr/local/bin/fig stop
end script
</code></pre>

<p>Теперь можно запустить тестовое окружение из любого места командой <code>start fig-test-env</code>, а остановить — <code>stop fig-test-env</code>.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://blog.dddpaul.pw/2015/01/04/docker-prepare/">
                    Подготовка и запуск docker-контейнеров
                </a>
            </h1>

            <span class="post-date">2015-01-04</span>

            

<p>Это первая статья цикла 
<a href='http://blog.dddpaul.pw//series/building-test-environments-with-docker/'>Building test environments with Docker</a>.</p>

<p>Сразу оговорюсь, что все docker-контейнеры основаны на <a href="http://phusion.github.io/baseimage-docker/">baseimage-docker</a>. Этот образ позволяет запускать в контейнере несколько приложений с помощью супервизора <a href="http://smarden.org/runit/">runit</a> и содержит ssh, cron, syslog &ldquo;из коробки&rdquo;.</p>

<p>Хотя подобный подход <a href="http://jpetazzo.github.io/2014/06/23/docker-ssh-considered-evil/">не рекомендуется разработчиками Docker</a>, он очень удобен в эксплуатации и не принуждает разработчика к своему &ldquo;proper way&rdquo;. Всегда можно использовать канонический подход от Docker с volumes и nsenter, а, при желании, подключаться к контейнерам по ssh.</p>

<p>Кроме того, я привык использовать сервера приложений в связке с nginx, и baseimage-docker позволяет легко это сделать.</p>

<h3 id="базовый-образ">Базовый образ</h3>

<p>При создании базового образа выполняются две вещи:</p>

<ul>
<li>публичный ssh-ключ добавляется в список разрешенных для суперпользователя контейнера;</li>
<li>задается локаль.</li>
</ul>

<p><em>Dockerfile</em> базового образа:</p>

<pre><code>FROM phusion/baseimage:0.9.15

# Add public SSH keys
ADD my_rsa_public_key /tmp/my_rsa_public_key
RUN cat /tmp/my_rsa_public_key &gt;&gt; /root/.ssh/authorized_keys &amp;&amp; rm -f /tmp/my_rsa_public_key

# Locale
ENV LANG=en_US.utf8

# Use baseimage-docker's init system
CMD [&quot;/sbin/my_init&quot;]
</code></pre>

<p>Свой публичный ssh-ключ, естественно, надо положить в <em>my_rsa_public_key</em> рядом с <em>Dockerfile</em>.</p>

<p>Сборка: <code>docker build -t smile/base .</code>
Запуск: <code>docker run --rm -it -p 2022:22 smile/base /sbin/my_init -- bash -l</code></p>

<p>Примечания:</p>

<ul>
<li><code>--rm</code> — используется для удаления контейнера после его остановки,</li>
<li><code>-it</code> — для терминального интерактивного режима,</li>
<li><code>-- bash -l</code> — для запуска шелла после запуска всех сервисов.</li>
</ul>

<p>Также на контейнер можно зайти по ssh: <code>ssh -p 2022 root@localhost</code>.</p>

<h3 id="образ-с-nginx">Образ с nginx</h3>

<p>Сборка <a href="https://github.com/dddpaul/docker-nginx">docker-nginx</a>: <code>docker build -t smile/nginx .</code></p>

<p>Основная особенность этого образа в том, что при запуске контейнера отключается IPv6.</p>

<p>Сделано это для того, чтобы обойти известную проблему с проксированием Nginx. Т.к. демон висит на tcp6, то апстрим иногда видит запрос от 127.0.0.1, а иногда от 0:0:0:0:0:0:0:1. Это принуждает к изменению ACL на сервере приложений, что не всегда удобно.</p>

<p>IPv6 отключается после выполнения серии sysctl-команд, которые требуют, чтобы контейнер был запущен в привилегированном режиме, т.е. команда запуска слегка усложняется:</p>

<pre><code>docker run --privileged --rm -it -p 2022:22 smile/nginx /sbin/my_init -- bash -l
</code></pre>

<h3 id="остальные-образы">Остальные образы</h3>

<p>На основе docker-nginx можно строить более сложные образы, такие как <a href="https://github.com/dddpaul/docker-java7-server">docker-java7-server</a> и  <a href="https://github.com/dddpaul/docker-tomcat7">docker-tomcat7</a>. На основе последнего уже строятся образы для конечных приложений.</p>

        </div>
        
        <div class="post">
            <h1 class="post-title">
                <a href="http://blog.dddpaul.pw/2014/07/28/oldest/">
                    First note
                </a>
            </h1>

            <span class="post-date">2014-07-28</span>

            <p>This blog is based on <a href="http://hugo.spf13.com/">Hugo</a> - static site generator written on Go. GitHub interaction is organized with use of <a href="http://hugo.spf13.com/tutorials/github_pages_blog">Hosting on GitHub Pages</a> tutorial. See &ldquo;Configure git Workflow&rdquo; section specifically.</p>

<p>And for all of the git 1.7.x (and older) users - you can grab <em>git-subtree</em> from <em>contrib</em> directory of <a href="https://github.com/git/git">Git repo</a>. I&rsquo;ve used <em>git-subtree</em> from latest 1.8.x. It&rsquo;s just a shell script, run <code>make</code>, <code>chmod +x git-subtree</code> and copy it to <em>/usr/lib/git-core</em>.</p>

        </div>
        
    </div>


<script type="text/javascript">
    (function (d, w, c) {
        (w[c] = w[c] || []).push(function() {
            try {
                w.yaCounter34067830 = new Ya.Metrika({
                    id:34067830,
                    clickmap:true,
                    trackLinks:true,
                    accurateTrackBounce:true
                });
            } catch(e) { }
        });

        var n = d.getElementsByTagName("script")[0],
                s = d.createElement("script"),
                f = function () { n.parentNode.insertBefore(s, n); };
        s.type = "text/javascript";
        s.async = true;
        s.src = "https://mc.yandex.ru/metrika/watch.js";

        if (w.opera == "[object Opera]") {
            d.addEventListener("DOMContentLoaded", f, false);
        } else { f(); }
    })(document, window, "yandex_metrika_callbacks");
</script>
<noscript><div><img src="https://mc.yandex.ru/watch/34067830" style="position:absolute; left:-9999px;" alt="" /></div></noscript>



</body>
</html>
